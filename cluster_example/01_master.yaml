heat_template_version: 2015-10-15

description: A webcluster example in one template. (there is no replication configured, only failover)

parameters:

  project_id:
    type: string

  api_user:
    type: string

  api_user_pass:
    type: string

  key_name:
    type: string
    description: Name of keypair to assign to servers

  image:
    type: string
    default: "Ubuntu 16.04 (LTS)"
    description: Image used for all servers

  lbflavor:
    type: string
    default: "Standard 1GB"
    description: Flavor used for lb servers
  lb_count:
    type: string
    default: 2
    description: lbserver is not needed if you use lbaas
  lb_port_http:
    type: string
    default: 80
    description: Port used by the load balancer facing external
  lb_floatingip:
    type: string
    default: 
    description: VIP used by the load balancer facing external and failing over via keepalived script

  appflavor:
    type: string
    default: "Standard 1GB"
    description: Flavor used for app servers
  app_count:
    type: string
    default: 2
  app_port_http:
    type: string
    default: 80
    description: Port used by the appservers (webservers) internal

  dbflavor:
    type: string
    default: "Standard 1GB"
    description: Flavor used for lb servers
  db_count:
    type: string
    default: 2
  db_vip:
    type: string
    default: "10.0.0.254"
    description: IP used by keepalived on dbservers and wordpress as MySQL VIP (must match userdata)

  deployflavor:
    type: string
    default: "Standard 1GB"
    description: Flavor used for deploy/bastion server

  master_availability_zones:
    type: comma_delimited_list
    default: ["AMS-EQ1","AMS-EQ3","AMS-EQ1","AMS-EQ3","AMS-EQ1","AMS-EQ3","AMS-EQ1","AMS-EQ3","AMS-EQ1","AMS-EQ3","AMS-EQ1","AMS-EQ3",]

  sec_group_router:
    type: comma_delimited_list
    default: ["allow-all","allow-icmp"]

  public_net:
    type: string
    default: floating
    description: ID or name of public network for which floating IP addresses will be allocated
  private_net_name:
    type: string
    default: net-private-01
    description: Name of private network to be created
  private_net_cidr:
    type: string
    default: 10.0.0.0/24
    description: Private network address (CIDR notation)
  private_net_gateway:
    type: string
    default: 10.0.0.1
    description: Private network gateway address
  private_net_pool_start:
    type: string
    default: 10.0.0.10
    description: Start of private network IP address allocation pool
  private_net_pool_end:
    type: string
    default: 10.0.0.250
    description: End of private network IP address allocation pool



resources:

################
## Networking ##
################

  sec_group_external:
    type: OS::Neutron::SecurityGroup
    properties:
      name:
        list_join: ['-', [ {get_param: 'OS::stack_name'}, 'secgroup-external']]
      rules:
#TCP
        - remote_ip_prefix: 0.0.0.0/0
          protocol: tcp
          direction: egress
        - remote_ip_prefix: 0.0.0.0/0
          protocol: tcp
          direction: ingress
          port_range_min: { get_param: app_port_http }
          port_range_max: { get_param: app_port_http }
        - remote_ip_prefix: 0.0.0.0/0
          protocol: tcp
          direction: ingress
          port_range_min: 443
          port_range_max: 443
        - remote_ip_prefix: 0.0.0.0/0
          protocol: tcp
          direction: ingress
          port_range_min: 22
          port_range_max: 22
        - remote_ip_prefix: 0.0.0.0/0
          protocol: tcp
          direction: egress
          port_range_min: 22
          port_range_max: 22
        - remote_ip_prefix: 0.0.0.0/0
          protocol: tcp
          direction: ingress
          port_range_min: 8000
          port_range_max: 8000

#UDP
        - remote_ip_prefix: 0.0.0.0/0
          protocol: udp
          direction: ingress
        - remote_ip_prefix: 0.0.0.0/0
          protocol: udp
          direction: egress
#ICMP
        - remote_ip_prefix: 0.0.0.0/0
          protocol: icmp
          direction: ingress
        - remote_ip_prefix: 0.0.0.0/0
          protocol: icmp
          direction: egress

  sec_group_internal:
    type: OS::Neutron::SecurityGroup
    properties:
      name:
        list_join: ['-', [ {get_param: 'OS::stack_name'}, 'secgroup-internal-allow-all']]
      rules:
#        - remote_ip_prefix: 0.0.0.0/0
        - direction: ingress
        - remote_ip_prefix: 0.0.0.0/0
          direction: egress
#        - remote_ip_prefix: ::/0
        - ethertype: IPv6
          direction: ingress
        - remote_ip_prefix: ::/0
          direction: egress
          ethertype: IPv6

  private_net:
    type: OS::Neutron::Net
    properties:
      name: 
        list_join: ['-', [ {get_param: 'OS::stack_name'}, {get_param: private_net_name }]]

  private_subnet:
    type: OS::Neutron::Subnet
    properties:
      network_id: { get_resource: private_net }
      cidr: { get_param: private_net_cidr }
      gateway_ip: { get_param: private_net_gateway }
      dns_nameservers: [{ get_param: private_net_gateway }]
      allocation_pools:
        - start: { get_param: private_net_pool_start }
          end: { get_param: private_net_pool_end }

  router:
    type: OS::Neutron::Router
    properties:
      admin_state_up: true
#      ha: true #All routers are deployed HA with OpenContrail by default
#      distributed: true #All routers are distributed with OpenContrail by default
      external_gateway_info:
        network: { get_param: public_net }

  router_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: private_net }
      fixed_ips:  [{"subnet": { get_resource: private_subnet }, "ip_address": { get_param: private_net_gateway }}]
      security_groups: { get_param: sec_group_router }

  router_interface:
    type: OS::Neutron::RouterInterface
    properties:
      router_id: { get_resource: router }
#      subnet_id: { get_resource: private_subnet }
      port_id: { get_resource: router_port }



############
## LBaaS ###
############
#not needed if you use lbserver instances

  loadbalancer:
    type: My::Cluster::Loadbalancer
    properties:
      app_port_http: { get_param: app_port_http }
      lb_port_http: { get_param: lb_port_http }
      public_net: { get_param: public_net }
      private_net_cidr: { get_param: private_net_cidr }
      subnet_id: { get_resource: private_subnet }

################
## Instances ###
################
#lbserver not needed if you use lbaas

  lbservers:
    type: OS::Heat::ResourceGroup
    properties:
      count: {get_param: lb_count }
      resource_def:
          type: My::Cluster::InstanceInternal
          properties:
            name:
              list_join: ['-', [ {get_param: 'OS::stack_name'}, 'lb%index%']]
            key_name: { get_param: key_name }
            image: { get_param: image }
            flavor: { get_param: lbflavor }
            private_net: { get_resource: private_net }
            sec_group: { get_resource: sec_group_external }
            private_subnet: { get_resource: private_subnet }
            availability_zones: { get_param: master_availability_zones }
            index: '%index%'
            user_data:
              str_replace:
                template: |
                  #! /bin/sh -v
                  #The OpenStack URL's don't resolve correct from openstack itself.
                  echo "193.138.207.10	identity.openstack.cloudvps.com" >> /etc/hosts
                  echo "193.138.207.10  network.openstack.cloudvps.com" >> /etc/hosts

                  apt-get update
                  apt install keepalived haproxy rsyslog tcpdump python python-requests dmidecode software-properties-common -y
                  add-apt-repository ppa:certbot/certbot -y
                  apt-get update
                  apt install certbot -y
                  
                  mkdir -p /etc/cloudvps/
                  wget -O /etc/cloudvps/ha-ip-failover.py https://raw.githubusercontent.com/RaymiiOrg/openstack-ha-floating-ip-failover/master/ha-ip-failover.py
                  chmod +x /etc/cloudvps/ha-ip-failover.py
                  
                  ip=$(ip a|grep -m 1 "scope global"|cut -d " " -f6|cut -d "/" -f1)

                  echo '{
                    "username": "$APIUSER",
                    "password": "$APIUSERPASS",
                    "tenant_id": "$PROJECTID",
                    "floatingips": {
                      "$FLOATINGIP": "'$ip'"
                    } 
                  }' > /etc/cloudvps/ha-ip-config.json
                  
                  echo "global_defs {
                     router_id lb1
                  }
                  vrrp_sync_group VG_1 {
                       group {
                          INTERN
                       }
                  }
                  
                  vrrp_instance VI_1 {
                      state MASTER
                      interface eth0
                      virtual_router_id 51
                      priority 150
                      advert_int 1
                      authentication {
                          auth_type PASS
                          auth_pass 
                      }
                      notify /etc/cloudvps/ha-ip-failover.py
                  }
                  
                  " >> /etc/keepalived/keepalived.conf
                  systemctl restart keepalived

                  sleep 5
                  mkdir /etc/ssl/private/ -p
                  certbot certonly --standalone --preferred-challenges http --http-01-port 80 -d $DOMAIN -m cees@cloudvps.com  --agree-tos -n

                  #Failback ssl if certbot fails
                  echo "-----BEGIN PRIVATE KEY-----
                  MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC259ydsb+nDZE2
                  sDvewMR/kLP6qAPQ+ivt1XYu/EZl/82aLK9sACOhVppDJ+OhyIG0VCXHOqY2SJC1
                  wrhjv+08FayuPBzq7O/L1dzwp2QR/YPAUyVoVN33nWH60TGjdKxgk2rRwjC+wG9Q
                  16olZFrXR5qjfgVnVuMAlSRNU3eXhdPJRteSNjWOvEGvnseDjbOE9Ho151eNY9B7
                  tSHTyfNYZRGd119iHnbGX/BOy9uSa29DrKuD9lX22wMa3etvcqqnFe/7MmQvFVcu
                  11oTZHDCl7TeMcbx6FSlsnsWLx88+L5MOm1KzSpe9ryEf3ePW6d8wVysJIhczEx1
                  tzWexldlAgMBAAECggEAFFZNkn8sFzAMAG+yCH+YmbKGQI2j9v2KGuTMQkcssLSz
                  sLvdOX3+eDb/6g2qYte/jER6+t8LkieZZ4xiIj057J9gVvM6J+j2dMyvx1Zlaxas
                  KptUInilQZ4PQes2wLz9WbOqge48q0kMV4nTUlsJOrysdhdSFH51uR/cLHjmaEN5
                  3dc3BlxJMYU8qaZRasE5W0bWQaF33nM8UrAK2jenQcrPaugohRe6XCCRk3ftWK9Q
                  dG+APNlRH/OB+lwsYdlrkiKBQPAn2txu+wiYTR8gA4yjJNISNHCeD5QU9ZfGOU1S
                  NoJvswbiV06QQDqsBOG7ZgUZaeWySa2O6nz6ZbqLtQKBgQDoWuYda6lMp+zmmQqa
                  TGJqVoKVWHiU7X3MxlOXMzKdODQKrtNY3i5HXZGr6RKHKiJS7JiEWeYfkn1/Htng
                  03XUabZZD02XhBkuQArFise7hpUB5Qzlot9igd5AhS9L8yAIG61x0fTsWyFrH4Us
                  mROI6F5N6uCOmN25JVLQyc2QgwKBgQDJhMDitOz5R4u422I3yZKjNGkOsIt62s9B
                  7aXsNlZKzELUxsU7NAGhIjreISpjUQpulzrGA8BBTvLBOPZ9arSptY3X7viM54py
                  PCMznfTz0HOWAldB1LcArWWwBVzb25YMyyzAQov1tWOUQZF8+B4FySvi+1VS6jHv
                  mgfT2zoj9wKBgQDhQO4A65RvGgSR8R/UQeTOzhs+CUyspCfm0wXKePnCbPAWwzFk
                  38/ho5ZLIGKz4mbwGSoqdLShOvSqvg/e42FBkVITuMAx+QAoVDGdHFNROsFN2u3L
                  2T/SUbBSwEr/yCzvb1WQGEjmsdoN7bq/Z48GlK6HvwH/e7bHfKVyf5DnXQKBgQCK
                  pkcb9EWzgZFVn8PlBFBa7/10eO2OmqvM/ZiSfBRFJGK7CQO8pxyT4/xCxujmKmUW
                  EAEFKqGFja8iWHHneppQxbSRJD9omwo7bLr/kadudTaBuJyWk6dR1PvI7vej4WJM
                  7SGeKmsnpCSeZbqXFBN8AZyrcCeVg8LVytGl5wkKowKBgDPkDxqxLjZtPPGHuK4A
                  7U0JqZlUyZL8XuXO5Ev7g01iCD6zffdJL/033E9O3YtAUNF7xQIg+09KzCZtFYeQ
                  Xt+a/fUWWkEFyeFd2YucVKZthM03utlMXyBsRQ7LHyag+nhONQnCDH5WaAXPpcdb
                  VS0zROebpYDsKbg+2GWNHHfO
                  -----END PRIVATE KEY-----
                  -----BEGIN CERTIFICATE-----
                  MIIFHzCCBAegAwIBAgISAw0DvELuwpFrwVG886zw8TmNMA0GCSqGSIb3DQEBCwUA
                  MEoxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MSMwIQYDVQQD
                  ExpMZXQncyBFbmNyeXB0IEF1dGhvcml0eSBYMzAeFw0xNzEwMTEwNzA4MTdaFw0x
                  ODAxMDkwNzA4MTdaMCkxJzAlBgNVBAMTHmtpbmRlcmJvZWtlbi5kZW1vLmNsb3Vk
                  dnBzLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALbn3J2xv6cN
                  kTawO97AxH+Qs/qoA9D6K+3Vdi78RmX/zZosr2wAI6FWmkMn46HIgbRUJcc6pjZI
                  kLXCuGO/7TwVrK48HOrs78vV3PCnZBH9g8BTJWhU3fedYfrRMaN0rGCTatHCML7A
                  b1DXqiVkWtdHmqN+BWdW4wCVJE1Td5eF08lG15I2NY68Qa+ex4ONs4T0ejXnV41j
                  0Hu1IdPJ81hlEZ3XX2IedsZf8E7L25Jrb0Osq4P2VfbbAxrd629yqqcV7/syZC8V
                  Vy7XWhNkcMKXtN4xxvHoVKWyexYvHzz4vkw6bUrNKl72vIR/d49bp3zBXKwkiFzM
                  THW3NZ7GV2UCAwEAAaOCAh4wggIaMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAU
                  BggrBgEFBQcDAQYIKwYBBQUHAwIwDAYDVR0TAQH/BAIwADAdBgNVHQ4EFgQUoOsl
                  4S5cw2MElpzo3q/bTfs0r4MwHwYDVR0jBBgwFoAUqEpqYwR93brm0Tm3pkVl7/Oo
                  7KEwbwYIKwYBBQUHAQEEYzBhMC4GCCsGAQUFBzABhiJodHRwOi8vb2NzcC5pbnQt
                  eDMubGV0c2VuY3J5cHQub3JnMC8GCCsGAQUFBzAChiNodHRwOi8vY2VydC5pbnQt
                  eDMubGV0c2VuY3J5cHQub3JnLzApBgNVHREEIjAggh5raW5kZXJib2VrZW4uZGVt
                  by5jbG91ZHZwcy5jb20wgf4GA1UdIASB9jCB8zAIBgZngQwBAgEwgeYGCysGAQQB
                  gt8TAQEBMIHWMCYGCCsGAQUFBwIBFhpodHRwOi8vY3BzLmxldHNlbmNyeXB0Lm9y
                  ZzCBqwYIKwYBBQUHAgIwgZ4MgZtUaGlzIENlcnRpZmljYXRlIG1heSBvbmx5IGJl
                  IHJlbGllZCB1cG9uIGJ5IFJlbHlpbmcgUGFydGllcyBhbmQgb25seSBpbiBhY2Nv
                  cmRhbmNlIHdpdGggdGhlIENlcnRpZmljYXRlIFBvbGljeSBmb3VuZCBhdCBodHRw
                  czovL2xldHNlbmNyeXB0Lm9yZy9yZXBvc2l0b3J5LzANBgkqhkiG9w0BAQsFAAOC
                  AQEABRKHLXRz51FCgXaP3vpHwIUD+BaXplOZ4OnVvXHohIpdR34LWkTsmDxt4A6R
                  gRn9KaFqTQ6tTubfpwSSoqlpCHZwk6nUoZHaD+jii9Q1E1JbCsXGkfDthqZwvAV9
                  z863hz5giIIEqmsCkAvJlscIV5BzRoIrgLy+G1Z52s0uF5pplaKuA0/ah+jWGSAQ
                  L07LRVDX0x4WhA1fWCdaJbYZLnQK/nzLHlxgFu7NgF0ZInce8ROtTbUZkg7iTFPq
                  DOxb4yXxnQ0/fTJMyrFy2HPnt23Dp1Vs/NQyGGkUSPOSFlbLnuSe2ErrB8Taois9
                  gT5RwmN367ur504DTTWhmyCweg==
                  -----END CERTIFICATE-----
                  -----BEGIN CERTIFICATE-----
                  MIIEkjCCA3qgAwIBAgIQCgFBQgAAAVOFc2oLheynCDANBgkqhkiG9w0BAQsFADA/
                  MSQwIgYDVQQKExtEaWdpdGFsIFNpZ25hdHVyZSBUcnVzdCBDby4xFzAVBgNVBAMT
                  DkRTVCBSb290IENBIFgzMB4XDTE2MDMxNzE2NDA0NloXDTIxMDMxNzE2NDA0Nlow
                  SjELMAkGA1UEBhMCVVMxFjAUBgNVBAoTDUxldCdzIEVuY3J5cHQxIzAhBgNVBAMT
                  GkxldCdzIEVuY3J5cHQgQXV0aG9yaXR5IFgzMIIBIjANBgkqhkiG9w0BAQEFAAOC
                  AQ8AMIIBCgKCAQEAnNMM8FrlLke3cl03g7NoYzDq1zUmGSXhvb418XCSL7e4S0EF
                  q6meNQhY7LEqxGiHC6PjdeTm86dicbp5gWAf15Gan/PQeGdxyGkOlZHP/uaZ6WA8
                  SMx+yk13EiSdRxta67nsHjcAHJyse6cF6s5K671B5TaYucv9bTyWaN8jKkKQDIZ0
                  Z8h/pZq4UmEUEz9l6YKHy9v6Dlb2honzhT+Xhq+w3Brvaw2VFn3EK6BlspkENnWA
                  a6xK8xuQSXgvopZPKiAlKQTGdMDQMc2PMTiVFrqoM7hD8bEfwzB/onkxEz0tNvjj
                  /PIzark5McWvxI0NHWQWM6r6hCm21AvA2H3DkwIDAQABo4IBfTCCAXkwEgYDVR0T
                  AQH/BAgwBgEB/wIBADAOBgNVHQ8BAf8EBAMCAYYwfwYIKwYBBQUHAQEEczBxMDIG
                  CCsGAQUFBzABhiZodHRwOi8vaXNyZy50cnVzdGlkLm9jc3AuaWRlbnRydXN0LmNv
                  bTA7BggrBgEFBQcwAoYvaHR0cDovL2FwcHMuaWRlbnRydXN0LmNvbS9yb290cy9k
                  c3Ryb290Y2F4My5wN2MwHwYDVR0jBBgwFoAUxKexpHsscfrb4UuQdf/EFWCFiRAw
                  VAYDVR0gBE0wSzAIBgZngQwBAgEwPwYLKwYBBAGC3xMBAQEwMDAuBggrBgEFBQcC
                  ARYiaHR0cDovL2Nwcy5yb290LXgxLmxldHNlbmNyeXB0Lm9yZzA8BgNVHR8ENTAz
                  MDGgL6AthitodHRwOi8vY3JsLmlkZW50cnVzdC5jb20vRFNUUk9PVENBWDNDUkwu
                  Y3JsMB0GA1UdDgQWBBSoSmpjBH3duubRObemRWXv86jsoTANBgkqhkiG9w0BAQsF
                  AAOCAQEA3TPXEfNjWDjdGBX7CVW+dla5cEilaUcne8IkCJLxWh9KEik3JHRRHGJo
                  uM2VcGfl96S8TihRzZvoroed6ti6WqEBmtzw3Wodatg+VyOeph4EYpr/1wXKtx8/
                  wApIvJSwtmVi4MFU5aMqrSDE6ea73Mj2tcMyo5jMd6jmeWUHK8so/joWUoHOUgwu
                  X4Po1QYz+3dszkDqMp4fklxBwXRsW10KXzPMTZ+sOPAveyxindmjkW8lGy+QsRlG
                  PfZ+G6Z6h7mjem0Y+iWlkYcV4PIWL1iwBi8saCbGS5jN2p8M+X+Q7UNKEkROb3N6
                  KOqkqm57TH2H3eDJAkSnh6/DNFu0Qg==
                  -----END CERTIFICATE-----
                  " > /etc/letsencrypt/live/$DOMAIN.pem
                  cat /etc/letsencrypt/live/$DOMAIN/privkey.pem > /etc/letsencrypt/live/$DOMAIN.pem
                  cat /etc/letsencrypt/live/$DOMAIN/cert.pem >> /etc/letsencrypt/live/$DOMAIN.pem
                  cat /etc/letsencrypt/live/$DOMAIN/chain.pem >> /etc/letsencrypt/live/$DOMAIN.pem
                  echo "frontend http-in
                      mode http
                      bind 0.0.0.0:80
                      bind 0.0.0.0:443 ssl crt /etc/letsencrypt/live/$DOMAIN.pem no-sslv3 crt-ignore-err all strict-sni

                      default_backend appservers
                  
                  backend appservers
                        mode            http
                        fullconn        40000
                        balance         roundrobin
                        cookie          SERVERID insert nocache indirect
                        option          httpchk HEAD /status.php
                        http-check      expect rstatus (2|3)[0-9][0-9]
                  #Server list should be made dynamic, but this works for now.
                        server          app11 10.0.0.11:80 check 
                        server          app12 10.0.0.12:80 check
                        server          app13 10.0.0.13:80 check
                        server          app14 10.0.0.14:80 check
                        server          app15 10.0.0.15:80 check
                        server          app16 10.0.0.16:80 check
                        server          app17 10.0.0.17:80 check
                        server          app18 10.0.0.18:80 check
                        server          app19 10.0.0.19:80 check
                        server          app20 10.0.0.20:80 check
                        server          app21 10.0.0.21:80 check
                        server          app22 10.0.0.22:80 check
                        server          app23 10.0.0.23:80 check
                        server          app24 10.0.0.24:80 check
                        server          app25 10.0.0.25:80 check
                        server          app26 10.0.0.26:80 check
                        server          app27 10.0.0.27:80 check
                        server          app28 10.0.0.28:80 check
                        server          app29 10.0.0.29:80 check
                  
                  frontend Statistics
                        mode http
                        bind 0.0.0.0:8000
                        option contstats
                        default_backend HAProxy-Statistics
                  
                  userlist UsersFor_HAProxyStatistics
                        group admin users admin
                        user admin insecure-password changeme
                  
                  backend HAProxy-Statistics
                        mode http
                        stats enable
                        stats uri /stats
                        stats refresh 10s
                        stats show-node
                        stats show-legends
                        acl AuthOkay_ReadOnly http_auth(UsersFor_HAProxyStatistics)
                        acl AuthOkay_Admin http_auth_group(UsersFor_HAProxyStatistics) admin
                        stats http-request auth realm HAProxy-Statistics unless AuthOkay_ReadOnly
                        stats admin if AuthOkay_Admin

                  " >> /etc/haproxy/haproxy.cfg
                  systemctl restart haproxy
                  

                params:
                  $FLOATINGIP: {get_param: 'lb_floatingip'}
                  $PROJECTID: {get_param: 'project_id'}
                  $APIUSER: {get_param: 'api_user'}
                  $APIUSERPASS: {get_param: 'api_user_pass'}
                  $DOMAIN: "f1shop.demo.cloudvps.com"


  dbserver_vip_port:
    type: OS::Neutron::Port
    properties:
      network_id: { get_resource: private_net }
      fixed_ips:
        - ip_address: { get_param: db_vip }

  dbservers:
    type: OS::Heat::ResourceGroup
    properties:
      count: {get_param: db_count }
      resource_def:
          type: My::Cluster::InstanceInternalVolVip
          properties:
            name:
              list_join: ['-', [ {get_param: 'OS::stack_name'}, 'db%index%']]
            key_name: { get_param: key_name }
            image: { get_param: image }
            flavor: { get_param: dbflavor }
            private_net: { get_resource: private_net }
            sec_group: { get_resource: sec_group_internal }
            user_data: { get_file: 'user_data_dbserver.sh' }
            private_subnet: { get_resource: private_subnet }
            availability_zones: { get_param: master_availability_zones }
            index: '%index%'
            allowed_address_pair: { get_param: db_vip }
 

  appservers:
    type: OS::Heat::ResourceGroup
    properties:
      count: {get_param: app_count }
      resource_def:
          type: My::Cluster::InstancePool
          properties:
            name: 
              list_join: ['-', [ {get_param: 'OS::stack_name'}, 'app%index%']]
            key_name: { get_param: key_name }
            image: { get_param: image }
            flavor: { get_param: appflavor }
            private_net: { get_resource: private_net }
            sec_group: { get_resource: sec_group_internal }
            app_port: { get_param: app_port_http }
            pool: { get_attr: [ loadbalancer, pool_id]}
            private_subnet: { get_resource: private_subnet }
            availability_zones: { get_param: master_availability_zones }
            index: '%index%'
            user_data:
              str_replace:
                template: |
                  #! /bin/sh -v
                  apt-get update
                  sudo apt install -y nginx php php-mysql php-curl php-gd php-mcrypt mysql-client
                  
                  sudo mkdir -p $WP_PATH/public $WP_PATH/logs
                  sudo rm /etc/nginx/sites-enabled/default
                  sudo tee /etc/nginx/sites-available/$WP_DOMAIN <<EOF
                  server {
                    listen 80;
                    server_name $WP_DOMAIN www.$WP_DOMAIN _;
                  
                    root $WP_PATH/public;
                    index index.php;
                  
                    access_log $WP_PATH/logs/access.log;
                    error_log $WP_PATH/logs/error.log;
                  
                    location / {
                      try_files \$uri \$uri/ /index.php?\$args;
                    }
                  
                    location ~ \.php\$ {
                      include snippets/fastcgi-php.conf;
                      fastcgi_pass unix:/run/php/php7.0-fpm.sock;
                    }
                  }
                  EOF
                  sudo ln -s /etc/nginx/sites-available/$WP_DOMAIN /etc/nginx/sites-enabled/$WP_DOMAIN
                  #sudo rm /etc/nginx/sites-enabled/default
                  sudo systemctl restart nginx
                  
                  
                  ### START The WP installation ###
                  
                  sudo rm -rf $WP_PATH/public/ # !!!
                  sudo mkdir -p $WP_PATH/public/
                  sudo chown -R $USER $WP_PATH/public/
                  cd $WP_PATH/public/
                  
                  wget https://wordpress.org/latest.tar.gz
                  tar xf latest.tar.gz --strip-components=1
                  tar --strip-components=1 -zxvf latest.tar.gz -C $WP_PATH/public
                  rm latest.tar.gz
                  
                  mv wp-config-sample.php wp-config.php
                  sed -i s/database_name_here/$WP_DB_NAME/ wp-config.php
                  sed -i s/username_here/$WP_DB_USERNAME/ wp-config.php
                  sed -i s/password_here/$WP_DB_PASSWORD/ wp-config.php
                  sed -i s/localhost/$WP_DB_HOST/ wp-config.php
                  echo "define('FS_METHOD', 'direct');" >> wp-config.php
                  
                  sudo chown -R www-data:www-data $WP_PATH/public/
                  
                  echo "waiting for databases"
                  until mysql -u $WP_DB_USERNAME -p$WP_DB_PASSWORD -h $WP_DB_HOST -e "show databases"; do sleep 2; done
                  echo "database found"
                  
                  
                  curl -H 'Host: $WP_DOMAIN' "http://127.0.0.1/wp-admin/install.php?step=2" \
                    --data-urlencode "weblog_title=$WP_DOMAIN"\
                    --data-urlencode "user_name=$WP_ADMIN_USERNAME" \
                    --data-urlencode "admin_email=$WP_ADMIN_EMAIL" \
                    --data-urlencode "admin_password=$WP_ADMIN_PASSWORD" \
                    --data-urlencode "admin_password2=$WP_ADMIN_PASSWORD" \
                    --data-urlencode "pw_weak=1"
                  hostname > /var/www/wordpress/public/status.php 
                  chown www-data:www-data /var/www/wordpress/public/status.php
                params:
                  $WP_DOMAIN: "f1shop.demo.cloudvps.com"
                  $WP_ADMIN_USERNAME: "admin"
                  $WP_ADMIN_PASSWORD: "admin"
                  $WP_ADMIN_EMAIL: "no@spam.org"
                  $WP_DB_NAME: "wordpress"
                  $WP_DB_USERNAME: "wordpress"
                  $WP_DB_PASSWORD: "wordpress"
                  $WP_DB_HOST: { get_param: db_vip }
                  $WP_PATH: "/var/www/wordpress"
                  $MYSQL_ROOT_PASSWORD: "root"
 



  deployserver:
    type: My::Cluster::InstanceFloat
    properties:
      name:
        list_join: ['-', [ {get_param: 'OS::stack_name'}, 'deployserver']]
      key_name: { get_param: key_name }
      image: { get_param: image }
      flavor: { get_param: deployflavor }
      private_net: { get_resource: private_net }
      private_subnet: { get_resource: private_subnet }
      sec_group: { get_resource: sec_group_external }
      public_net: { get_param: public_net }
      user_data: { get_file: 'user_data_deploy.sh' }
      availability_zones: { get_param: master_availability_zones }
      index: 0


#############
## Outputs ##
#############

outputs:

  LBaaS_Floating_ip:
    value: { get_attr: [ loadbalancer, floating_ip ] }
    description: The floating ip of the LBaaS loadbalaner
  LB_Floating_ip:
    value: { get_param: 'lb_floatingip' }
    description: The floating ip of the loadbalaner servers configured in keepalived
  Deployserver_Float_ip:
    value: { get_attr: [ deployserver, floating_ip ] }
    description: The floating ip of the deployserver
  LBservers_ip:
    description: "internal ip addresses of lb servers"
    value: { get_attr: [ lbservers, instance_ip]}
  Appservers_ip:
    description: "ip addresses of appservers"
    value: { get_attr: [ appservers, instance_ip]}
  DBservers_ip:
    description: "ip addresses of dbservers"
    value: { get_attr: [ dbservers, instance_ip]}

